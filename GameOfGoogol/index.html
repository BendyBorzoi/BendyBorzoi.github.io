<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Game of Googol</title>
    <script src="knockout-3.5.0.js"></script>
    <link rel="icon" type="image/png" href="favicon.png"/>
    <link rel="stylesheet" href="bootstrap-4.3.1-dist/css/bootstrap.min.css">
    <style>
        .arrDisplay {
            margin: 10px 0;
        }

        .navbar-brand {
            pointer-events: none;
        }

        html {
            position: relative;
            min-height: 100%;
        }

        body {
            margin-bottom: 60px;
        }

        .footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 60px;
            line-height: 60px;
            background-color: #f5f5f5;
        }

        main {
            padding: 60px 0;
        }
    </style>
</head>
<body>
<header>
    <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
        <a class="navbar-brand" href="#">The Game of Googol</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse"
                aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item"><a data-bind="click: goToGame, class: gameActive" href="#">Play the game</a></li>
                <li class="nav-item"><a data-bind="click: goToPupper, class: gameInactive" href="#">Visit the Rare
                    <span data-bind="text: char"></span></a></li>
            </ul>
        </div>
    </nav>
</header>
<main>
    <div class="container" data-bind="visible: playGame">
        <div class="col-md-12">
            <div data-bind="visible: showRules">
                Da Rules:<br>
                You are given a set of unknown integers, values ranging from 0 to 10^100. You choose how many unknowns
                there are.<br>
                The values are randomly generated and shuffled.<br>
                At the start of the game, you reveal the first integer. You are then given a choice: Choose this number
                or reveal another number.<br>
                The same choice is given after every reveal. If you reveal another number, you can only choose the newly
                revealed number.<br>
                If you reveal all numbers in the set, you have to choose the last number you revealed. <br>
                Once you have chosen, the chosen number is then compared to each number in the initial set.<br>
                If you have chosen the largest number in the set, you win, else, you lose.<br>
                You may wager Pupper points, but be aware, their value is inconceivable. Winning the game will grant you
                your wager fourfold.<br>
                You may visit the rare <span data-bind="text: char"></span> and pet him to gain more Pupper Points.<br>
                My inspiration and a great video on the Game of Googol:
                <a href="https://www.youtube.com/watch?v=OeJobV4jJG0" target="_blank"
                >https://www.youtube.com/watch?v=OeJobV4jJG0</a><br>
                <button data-bind="click: hideRules" class="btn btn-primary">Hide rules</button>
                <br><br>
            </div>
            <div data-bind="hidden: gameStarted() || gameEnded()">
                <form class="form-inline" data-bind="submit: startGame">
                    <div class="form-row align-items-center">
                        <div class="col-md-5">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <label for="num" class="input-group-text">Number of unknowns:</label>
                                </div>
                                <input type="number" min="10" max="1000" step="1"
                                       data-bind="value: numberOfUnknowns" class="form-control" id="num">
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <label for="wag" class="input-group-text">Your Wager:</label>
                                </div>
                                <input type="number" min="0" step="1"
                                       data-bind="value: wager, attr: {max: rarePuppers}" class="form-control" id="wag">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary">Start</button>
                        </div>
                    </div>
                </form>
            </div>
            <div data-bind="visible: gameStarted">
                Number of initial unknowns: <span data-bind="text: numberOfUnknowns"></span>;
                Number of revealed integers: <span data-bind="text: revealedCount"></span>;
                Your wager: <span data-bind="text: wager"></span><br>
                <span data-bind="html: knownPretty"></span><br><br>
                <button data-bind="click: reveal, enable: revealedCount() < unknowns().length" class="btn btn-primary">
                    Reveal the Next Number
                </button>
                <button data-bind="click: choose, enable: revealedCount" class="btn btn-primary">Choose This Number
                </button>
            </div>
            <div data-bind="visible: gameEnded">
                <h1 data-bind="text: outcome"></h1><br>
                Number of initial unknowns: <span data-bind="text: numberOfUnknowns"></span>;
                Number of revealed integers: <span data-bind="text: revealedCount"></span>;
                Your wager: <span data-bind="text: wager"></span><br>
                <div class="arrDisplay">Revealed integers:<br><span data-bind="html: knownPretty"></span><br></div>
                Chosen Integer: <span data-bind="html: chosen"></span><br>
                Largest Integer: <span data-bind="html: largestNumber"></span><br>
                <div class="arrDisplay">Initial unknowns:<br><span data-bind="html: unknownsPretty"></span><br></div>
                <br>
                <button data-bind="click: reset" class="btn btn-primary">Reset game</button>
            </div>
        </div>
    </div>
    <div data-bind="hidden: playGame">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%)">
            <div style="cursor: grab" data-bind="event: {mouseover: pupperHover, mouseout: pupperNotHover}">
                <img style="height: 400px" data-bind="click: generatePupper, attr: {src: pupperPic}" alt="Pupper">
            </div>
            <br>
            <button style="position: absolute; left: 50%; transform: translate(-50%,0)" class="btn btn-primary"
            data-bind="visible: char() !== 'Woofer', enable: rarePuppers() >= cost(), click: upgrade">
                Use <span data-bind="text: costPretty"></span> Pupper Points to summon the Rare <span data-bind="text: nextUpgrade"></span>
            </button>
        </div>
    </div>
</main>
<footer class="footer">
    <div class="container">
        <div>
            Won: <span data-bind="text: wonGames"></span>;
            Lost: <span data-bind="text: lostGames"></span>;
            <span data-bind="visible: wonGames() || lostGames()">Win rate: <span
                    data-bind="text: winRate"></span>;</span>
            Pupper Points: <span data-bind="text: Intl.NumberFormat().format(rarePuppers())"></span>
            <div style="float: right">
                <button data-bind="click: showRulesAgain, hidden: showRules" class="btn btn-outline-secondary">
                    Show rules
                </button>
            </div>
        </div>
    </div>
</footer>
<script>
    if (localStorage.getItem('wonGames') === null) {
        localStorage.setItem('wonGames', "0");
    }
    if (localStorage.getItem('lostGames') === null) {
        localStorage.setItem('lostGames', "0");
    }
    if (localStorage.getItem('showRules') === null) {
        localStorage.setItem('showRules', "1");
    }
    if (localStorage.getItem('rarePuppers') === null) {
        localStorage.setItem('rarePuppers', "0");
    }
    if (localStorage.getItem('char') === null) {
        localStorage.setItem('char', "Pupper");
    }

    class NumGoo {
        constructor() {
            this.val = Math.random();
            this.exp = Math.floor((Math.random() * 99) + 1);
            if (Math.random() > 0.999999) {
                this.val = 1;
                this.exp = 100;
            }
            while (this.val < 0.1 && this.val) {
                this.val *= 10;
            }
            if (this.exp < 17) {
                this.val = Math.floor(this.val * Math.pow(10, this.exp)) / Math.pow(10, this.exp);
            }
        }

        get abs() {
            return this.val * Math.pow(10, this.exp);
        }

        get prettyVal() {
            return (Math.floor(this.val * Math.pow(10, Math.min(5, this.exp)) + 1) /
                (Math.pow(10, Math.min(5, this.exp) - 1))).toPrecision(5);
        }

        get prettyAbs() {
            if (this.exp === 100) {
                return 'Googol';
            }
            return '<span title="' + this.abs + '"><span>' + this.prettyVal
                + '</span> &times; 10<sup><span>' + (this.exp - 1) + '</span></sup></span>';
        }
    }

    function displayArr(arr) {
        let res = '';
        for (let a of arr) {
            res += a.prettyAbs;
            if (arr.indexOf(a) !== arr.length - 1) {
                res += ', ';
            }
        }
        return '[ ' + res + ' ]';
    }

    let VM = function () {
        let self = this;
        self.showRules = ko.observable(+localStorage.getItem('showRules'));
        self.hideRules = function () {
            self.showRules(0);
            localStorage.setItem('showRules', "0");
        };
        self.showRulesAgain = function () {
            self.showRules(1);
            localStorage.setItem('showRules', "1");
        };
        self.unknowns = ko.observableArray();
        self.known = ko.observableArray();
        self.revealedCount = ko.observable(0);
        self.numberOfUnknowns = ko.observable(10);
        self.chosen = ko.observable(0);
        self.largestNumber = ko.observable(0);
        self.gameStarted = ko.observable(false);
        self.gameEnded = ko.observable(false);
        self.outcome = ko.observable('');
        self.knownPretty = ko.pureComputed(() => displayArr(self.known()));
        self.unknownsPretty = ko.pureComputed(() => displayArr(self.unknowns()));
        self.wonGames = ko.observable(+localStorage.getItem('wonGames'));
        self.lostGames = ko.observable(+localStorage.getItem('lostGames'));
        self.rarePuppers = ko.observable(+localStorage.getItem('rarePuppers'));
        self.playGame = ko.observable(true);
        self.gameActive = ko.pureComputed(() => self.playGame() ? 'nav-link active' : 'nav-link');
        self.gameInactive = ko.pureComputed(() => self.playGame() ? 'nav-link' : 'nav-link active');
        self.char = ko.observable(localStorage.getItem('char'));
        self.nextUpgrade = ko.pureComputed(() => self.char() === 'Pupper' ?  'Doggo' : 'Woofer');
        self.charPic = ko.pureComputed(() => 'normal' + self.char() + '.png');
        self.charPicHappy = ko.pureComputed(() => 'happy' + self.char() + '.png');
        self.cost = ko.computed(() => self.char() === 'Pupper' ? 100000 : 100000000000);
        self.costPretty = ko.pureComputed(() => Intl.NumberFormat().format(self.cost()));
        self.goToGame = function () {
            self.playGame(true);
        };
        self.goToPupper = function () {
            self.playGame(false);
        };
        self.generatePupper = function () {
            let a;
            switch (self.char()) {
                case 'Pupper':
                    a = 1;
                    break;
                case 'Doggo':
                    a = 2;
                    break;
                default:
                    a = 10;
            }
            self.rarePuppers(self.rarePuppers() + a);
            localStorage.setItem('rarePuppers', self.rarePuppers());
        };
        self.wager = ko.observable(0);
        self.pupperPic = ko.observable(self.charPic());
        self.pupperHover = function () {
            self.pupperPic(self.charPicHappy());
        };
        self.pupperNotHover = function () {
            self.pupperPic(self.charPic());
        };
        self.winRate = ko.pureComputed(
            () => Math.round((self.wonGames() / (self.wonGames() + self.lostGames())) * 100) + '%'
        );
        self.startGame = function () {
            let a = self.numberOfUnknowns();
            self.gameStarted(true);
            self.rarePuppers(self.rarePuppers() - self.wager());
            localStorage.setItem('rarePuppers', self.rarePuppers());
            while (a > 0) {
                self.unknowns.push(new NumGoo());
                a--;
            }
        };
        self.reveal = function () {
            self.known.push(self.unknowns()[self.revealedCount()]);
            self.revealedCount(self.revealedCount() + 1);
        };
        self.choose = function () {
            let chosen = self.known()[self.revealedCount() - 1];
            self.chosen(chosen.prettyAbs);
            let arr = self.unknowns();
            arr.sort((a, b) => b.abs - a.abs);
            if (chosen.abs === arr[0].abs) {
                self.outcome('You won' + (self.wager() ? ' ' + (self.wager() * 4) + ' Pupper Points' : '') + '! üëç');
                self.wonGames(self.wonGames() + 1);
                localStorage.setItem('wonGames', '' + self.wonGames());
                self.rarePuppers(self.rarePuppers() + (self.wager() * 4));
                localStorage.setItem('rarePuppers', self.rarePuppers());
            } else {
                self.outcome('You lost! üëé');
                self.lostGames(self.lostGames() + 1);
                localStorage.setItem('lostGames', '' + self.lostGames());
            }
            self.largestNumber(arr[0].prettyAbs);
            self.gameStarted(false);
            self.gameEnded(true);
        };
        self.reset = function () {
            self.unknowns([]);
            self.known([]);
            self.revealedCount(0);
            self.largestNumber(0);
            self.gameStarted(false);
            self.gameEnded(false);
            self.outcome('');
        };
        self.upgrade = function () {
            if(self.char() === "Pupper") {
                self.rarePuppers(self.rarePuppers() - self.cost());
                localStorage.setItem('rarePuppers', self.rarePuppers());
                localStorage.setItem('char', "Doggo");
                self.char("Doggo");
                self.pupperNotHover();
            } else if(self.char() === "Doggo") {
                self.rarePuppers(self.rarePuppers() - self.cost());
                localStorage.setItem('rarePuppers', self.rarePuppers());
                localStorage.setItem('char', "Woofer");
                self.char("Woofer");
                self.pupperNotHover();
            }
        }
    }, vm = new VM();
    ko.applyBindings(vm);
</script>
</body>
</html>