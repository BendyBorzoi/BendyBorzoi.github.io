<html id="fullDoc">
<head>
    <title data-bind="text: timerTitle"></title>
    <link rel="shortcut icon" type="image/x-icon" href="img/clock.png"/>
    <script type='text/javascript'
            src="https://cdnjs.cloudflare.com/ajax/libs/knockout/3.4.2/knockout-debug.js"></script>
    <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.js'></script>
    <style>
        body {
            background-color: #111;
            color: #600;
            font-size: 7vw;
            font-family: 'courier new', 'sans-serif';
            margin: 0;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .cdInput {
            background-color: #222;
            color: #ccc;
            font-size: 2vw;
        }

        .cdDisplay {
            text-align: center;
        }
    </style>
</head>
<body>
<div data-bind="visible: timerInputs, event:{keyup: $root.enterKey}">
    <input class="cdInput" type="number"
           data-bind="value: timerInput" placeholder="hours">
    <input class="cdInput" type="number"
           data-bind="value: timerInput2" placeholder="minutes"><br>
    <input class="cdInput" type="text"
           data-bind="value: timerMsg" placeholder="message on completion"><br>
</div>
<div class="cdDisplay">
    <div><span data-bind="text: timerString"></span></div>
    <div style="font-size: 3vw"><span data-bind="text: timerText"></span></div>
</div>
<script>

    let audio = new Audio("sounds/smw_coin.wav"),
        audio2 = new Audio("sounds/stuffed-and-dropped-30.mp3"),
        cdGoal,
        timerInt,
        interval,
        interval2,
        msg;

    function TimerViewModel() {
        let self = this;
        self.timerInputs = ko.observable(true);
        self.timerInput = ko.observable();
        self.timerInput2 = ko.observable();
        self.timerMsg = ko.observable();
        self.timerText = ko.observable();
        self.timerTitle = ko.observable("Still Counting");
        self.timerString = ko.observable();
        self.enterKey = function (vm, event) {
            if (event.which === 13) self.init();
        };
        this.init = function () {
            cdGoal = moment().startOf('day').hours(self.timerInput()).minutes(self.timerInput2());
            if (self.timerMsg()) {
                msg = self.timerMsg();
                self.timerText(msg);
            } else {
                msg = "timer is done"
            }
            onbeforeunload = function () {
                return "timer is active"
            };
            self.timerInputs(false);
            audio.play().then();
            interval2 = setInterval(self.init2, 20);
        };
        this.init2 = function () {
            let temp = moment().milliseconds();
            if (temp % 1000 > 300 && temp % 1000 < 700) {
                clearInterval(interval2);
                self.tick();
                interval = setInterval(self.tick, 1000);
            }
        };
        this.tick = function () {
            timerInt = cdGoal.diff(moment());
            if (timerInt > 0) {
                let timerString = moment().startOf("day").milliseconds(timerInt + 1000).format("HH:mm:ss");
                self.timerString(timerString);
                self.timerTitle(msg === "timer is done" ? timerString : timerString + ' ' + msg);
            } else {
                self.timerString(msg);
                self.timerTitle(msg);
                self.timerText("finished at " + moment().format("HH:mm:ss"));
                clearInterval(interval);
                onbeforeunload = null;
                audio2.play().then();
            }
        };
    }

    ko.applyBindings(new TimerViewModel(), document.getElementById("fullDoc"));
</script>
</body>
</html>